<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Test de D3</title>
        <!--        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>-->
        <script src="d3/d3.js" type="text/javascript"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <h1>Test de la librairie D3</h1>
        <input type="file" id="files" name="files[]" multiple />
        <output id="list"></output>



        <script type="text/javascript">
            var jsonFile;
            var jsonPath;
            var jsonData; // global

            var svgContainer;
            var rectangles;
            var rectanglesAttr;



            //pour selectionner le fichier json
            function handleFileSelect(evt) {
                var files = evt.target.files; // FileList object

                // files is a FileList of File objects. List some properties.
                var output = [];
                for (var i = 0, f; f = files[i]; i++) {
                    output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                            f.size, ' bytes, last modified: ',
                            f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                            '</li>');
                    jsonFile = f.name;
                    jsonPath = "./datas/" + jsonFile;
        //            console.log(jsonPath);
                    jsonRecup(jsonPath);
                }
                document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
            }

            document.getElementById('files').addEventListener('change', handleFileSelect, false);


            function jsonRecup(jsonPath) {
                //récup des données du fichier json
                d3.json(jsonPath, function(error, json) {
                    
                    if (error) return console.warn(error);
                    
                    console.log(json);

                    createSvgScale(json);
                    createRect(json);

                });
            }

            //creation de la balise <svg>
            function createSvgScale(jsonData) {
                 var XInitialData = [];
                 var YInitialData = [];
                 
                //calcul des coord max des axes
                for (i = 0; i < jsonData.length; ++i) {
                    XInitialData[i] = jsonData[i].x_axis;
                    YInitialData[i] = jsonData[i].y_axis;
                }
               

                var XMinDataPoint = d3.min(XInitialData);
                var XMaxDataPoint = d3.max(XInitialData);
                
                var YMinDataPoint = d3.min(YInitialData);
                var YMaxDataPoint = d3.max(YInitialData);

                //on modifie l'échelle des abscisses et ordonnées
                var XLinearScale = d3.scale.linear()
                        .domain([XMinDataPoint, XMaxDataPoint])
                        .range([0, 300]);
                
                var YLinearScale = d3.scale.linear()
                        .domain([YMinDataPoint, YMaxDataPoint])
                        .range([0, 300]);

                //recalcule de chaque points (x,y) dans la nouvelle échelle de coordonnées       
                for (var i = 0; i < jsonData.length; i++) {
                    jsonData[i].x_axis = XLinearScale(jsonData[i].x_axis);
                    jsonData[i].y_axis = YLinearScale(jsonData[i].y_axis);
                }
                
                createSvg(jsonData);
                
            }

            //creation de la balise <svg>
            function createSvg(jsonData) {
                var max_x = 0;
                var max_y = 0;

                //calcul des coord max des axes
                for (i = 0; i < jsonData.length; ++i) {
                    var temp_x = jsonData[i].x_axis + jsonData[i].width;
                    var temp_y = jsonData[i].y_axis + jsonData[i].height;

                    if (max_x < temp_x) {
                        max_x = temp_x;
                    }

                    if (max_y < temp_y) {
                        max_y = temp_y;
                    }

                }

                svgContainer = d3.select("body").append("svg").attr("width", max_x).attr("height", max_y);
                console.log(svgContainer);

            }

            //création des balises <rect> en fonction des données du fichier Json
            function createRect(jsonData) {

                rectangles = svgContainer.selectAll("rect").data(jsonData).enter().append("rect");
                console.log(rectangles);

                rectanglesAttr = rectangles
                        .attr("x", function(d) {
                            return d.x_axis;
                        })
                        .attr("y", function(d) {
                            return d.y_axis;
                        })
                        .attr("height", function(d) {
                            return d.height;
                        })
                        .attr("width", function(d) {
                            return d.width;
                        })
                        .attr("fill", function(d) {
                            return d.color;
                        })
                console.log(rectanglesAttr);
            }

        </script>
    </body>

</html>